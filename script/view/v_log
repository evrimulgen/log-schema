CREATE OR REPLACE VIEW LOG_AUDITORIA.V_LOG AS
select l.DATA_log ,
       L.SEQ,
       tipo  AS Prioridade,

       lu.cod_update ,
       lu.data_update,
       lu.descricao as descricao_update,
      XMLELEMENT
      (
        "log",xmlattributes(to_char( l.data_log,'YYYY-MM-DD"T"hh24:mi:ss.ff6') as "data",  l.seq as "seq"),
        (
            SELECT xmlAgg
            (
               XMLELEMENT
               ("update",xmlattributes( lu.cod_update "update",to_char(lu.data_UPDATE,'yyyy-mm-dd"T"hh:mi:ss') as "data", lu.descricao as "descricao"),
                  (
                     SELECT xmlAgg(
                         case lp.especializacao
                         when 1  then XMLELEMENT("parametro",xmlattributes( lp.name as "nome", lp.especializacao AS "dataType"),xmltype(lp.valor) )
                         else XMLELEMENT("parametro",xmlattributes( lp.name as "nome", lp.especializacao AS "dataType"), lp.valor)
                         end
                     )
                     FROM LOG_AUDITORIA.v_parametro lp
                     where lp.data_log=l.data_log and lp.seq=l.seq and lp.cod_update=lu.cod_update
                  )
               )
            )
            FROM LOG_AUDITORIA.tab_update lu
            where lu.data_log=l.data_log and lu.seq=l.seq
        )
      )as log,
      C.path_CONTEXTO,
      C.id_relacao ,
      C.id_contexto

from LOG_AUDITORIA.tab_log l
      join LOG_AUDITORIA.TAB_UPDATE lu on lu.data_log=l.data_log and lu.seq=l.seq and lu.cod_update=
     ( select max(tlu.cod_update) as last_update from  LOG_AUDITORIA.tab_update tlu where tlu.data_log=l.data_log and tlu.seq=l.seq )
     join LOG_AUDITORIA.Tab_Prioridade p on l.tipo=p.id
     LEFT JOIN LOG_AUDITORIA.V_CONTEXTO C ON C.id_relacao=L.ID_RELACAO;
